# Base configuration for language-agnostic hooks
# These hooks can be used across any project regardless of programming language

pre-commit:
  commands:
    format:
      # Simple formatting fixes: remove trailing whitespace and ensure final newline
      run: basefmt {staged_files} && git add {staged_files}
      glob: '*'

    prettier:
      run: |
        if [ -f bun.lockb ] || [ -f bun.lock ]; then
          runner="bun x"
        elif [ -f pnpm-lock.yaml ]; then
          runner="pnpm exec"
        elif [ -f package.json ]; then
          runner="npx"
        else
          runner="mise x --"
        fi
        $runner prettier --write --ignore-unknown --no-error-on-unmatched-pattern {staged_files} && git add {staged_files}

    shellcheck:
      file_types:
        - text/x-shellscript
      exclude:
        - '*.zsh'
      run: mise x shellcheck -- shellcheck {staged_files}

    shfmt:
      file_types:
        - text/x-shellscript
      exclude:
        - '*.zsh'
      run: mise x shfmt -- shfmt --apply-ignore -w {staged_files} && git add {staged_files}

    actionlint:
      glob: '.github/workflows/*.{yml,yaml}'
      run: mise x actionlint -- actionlint {staged_files}

    copier-src-path:
      glob: '.copier-answers.yml'
      run: |
        # Check if _src_path uses gh: prefix (not supported by Renovate)
        # See: https://github.com/renovatebot/renovate/issues/39938
        for file in {staged_files}; do
          if [ -f "$file" ]; then
            # Handle both quoted and unquoted values (e.g., gh:org/repo or "gh:org/repo")
            if grep -qE "^_src_path:[[:space:]]*['\"]?gh:" "$file"; then
              src_path=$(grep -E "^_src_path:" "$file" | head -n 1 | sed 's/^_src_path:[[:space:]]*//')
              suggested_path=$(echo "$src_path" | sed -e "s|^['\"]\\{0,1\\}gh:|https://github.com/|" -e "s|['\"]\\{0,1\\}$||")
              echo "Error: $file uses 'gh:' prefix in _src_path, which is not supported by Renovate." >&2
              echo "Please use a full 'https://' URL instead." >&2
              printf "  Current:   %s\n  Suggested: %s\n" "$src_path" "$suggested_path" >&2
              exit 1
            fi
          fi
        done

commit-msg:
  commands:
    commitlint:
      run: |
        if [ -f bun.lockb ] || [ -f bun.lock ]; then
          runner="bun x"
        elif [ -f pnpm-lock.yaml ]; then
          runner="pnpm exec"
        elif [ -f package.json ]; then
          runner="npx"
        else
          exit 0
        fi
        $runner commitlint --edit {1}
